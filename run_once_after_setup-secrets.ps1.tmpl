# chezmoi:template:line-endings=crlf
$ErrorActionPreference = "Stop"
Write-Host ">>> Secrets 구조 설정을 시작합니다." -ForegroundColor Cyan

function Ensure-BlockInFile {
    param(
        [Parameter(Mandatory = $true)] [string]$Path,
        [Parameter(Mandatory = $true)] [string]$StartMarker,
        [Parameter(Mandatory = $true)] [string]$EndMarker,
        [Parameter(Mandatory = $true)] [string]$Block
    )

    if (!(Test-Path $Path)) {
        New-Item -ItemType File -Path $Path -Force | Out-Null
    }

    $raw = Get-Content -Path $Path -Raw -ErrorAction SilentlyContinue
    if ($null -eq $raw) { $raw = "" }

    if ($raw.Contains($StartMarker) -and $raw.Contains($EndMarker)) {
        Write-Host "이미 적용됨: $Path" -ForegroundColor DarkGray
        return
    }

    if ($raw.Length -gt 0 -and -not $raw.EndsWith("`n")) {
        Add-Content -Path $Path -Value "" -Encoding UTF8
    }
    Add-Content -Path $Path -Value $Block -Encoding UTF8
    Write-Host "블록 추가 완료: $Path" -ForegroundColor Green
}

# 1) Windows: ~/.secrets 폴더 + 템플릿 파일
$windowsSecretsDir = Join-Path $HOME ".secrets"
if (!(Test-Path $windowsSecretsDir)) {
    New-Item -ItemType Directory -Path $windowsSecretsDir -Force | Out-Null
    Write-Host "생성됨: $windowsSecretsDir" -ForegroundColor Green
}

$windowsTemplate = @'
# format: KEY=VALUE
# 값은 따옴표 없이 넣어도 됩니다.

GITHUB_PAT=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GOOGLE_API_KEY=
'@
$windowsTemplatePath = Join-Path $windowsSecretsDir "dev.env.example"
if (!(Test-Path $windowsTemplatePath)) {
    Set-Content -Path $windowsTemplatePath -Value $windowsTemplate -Encoding UTF8
    Write-Host "샘플 파일 생성: $windowsTemplatePath" -ForegroundColor Green
}

$windowsSecretsReadme = @'
# Local secrets directory

- 여기에 실제 토큰/API 키를 저장합니다.
- 이 디렉터리와 파일은 절대 git에 커밋하지 않습니다.
- 파일 포맷: KEY=VALUE

권장 파일:
- dev.env

점검:
- PowerShell: Secrets-Check
- WSL Bash: secrets_check
'@
$windowsReadmePath = Join-Path $windowsSecretsDir "README.md"
if (!(Test-Path $windowsReadmePath)) {
    Set-Content -Path $windowsReadmePath -Value $windowsSecretsReadme -Encoding UTF8
}

# 2) Windows PowerShell profile에 secrets 자동 로더 추가
$profilePath = $PROFILE.CurrentUserAllHosts
$profileDir = Split-Path -Parent $profilePath
if (!(Test-Path $profileDir)) {
    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
}

$psStart = "# >>> DOTFILES SECRETS LOADER >>>"
$psEnd = "# <<< DOTFILES SECRETS LOADER <<<"
$psBlock = @'
# >>> DOTFILES SECRETS LOADER >>>
$env:SECRETS_DIR = Join-Path $HOME ".secrets"

function Import-SecretsEnvFile {
    param([Parameter(Mandatory = $true)][string]$Path)

    Get-Content -Path $Path | ForEach-Object {
        $line = $_.Trim()
        if (-not [string]::IsNullOrWhiteSpace($line) -and -not $line.StartsWith("#")) {
            $parts = $line -split "=", 2
            if ($parts.Count -eq 2) {
                $name = $parts[0].Trim()
                $value = $parts[1].Trim().Trim('"').Trim("'")
                if (-not [string]::IsNullOrWhiteSpace($name)) {
                    Set-Item -Path "Env:$name" -Value $value
                }
            }
        }
    }
}

if (Test-Path $env:SECRETS_DIR) {
    Get-ChildItem -Path $env:SECRETS_DIR -Filter "*.env" -File -ErrorAction SilentlyContinue |
        ForEach-Object { Import-SecretsEnvFile -Path $_.FullName }
}

function Secrets-Check {
    param(
        [string[]]$Names = @("GITHUB_PAT", "OPENAI_API_KEY", "ANTHROPIC_API_KEY", "GOOGLE_API_KEY")
    )

    foreach ($name in $Names) {
        $value = [Environment]::GetEnvironmentVariable($name, "Process")
        if ([string]::IsNullOrWhiteSpace($value)) {
            Write-Host "$name: MISSING" -ForegroundColor Yellow
        } else {
            Write-Host "$name: OK" -ForegroundColor Green
        }
    }
}

Set-Alias -Name secrets-check -Value Secrets-Check -ErrorAction SilentlyContinue
# <<< DOTFILES SECRETS LOADER <<<
'@
Ensure-BlockInFile -Path $profilePath -StartMarker $psStart -EndMarker $psEnd -Block $psBlock

# 3) WSL(Ubuntu): ~/.secrets + ~/.bashrc 로더 블록 반영
$distros = @(wsl --list --quiet 2>$null | ForEach-Object { $_.Trim() } | Where-Object { $_ })
$ubuntu = $distros | Where-Object { $_ -like "Ubuntu*" } | Select-Object -First 1

if (-not $ubuntu) {
    Write-Host "Ubuntu 배포판이 없어 WSL secrets 설정은 건너뜁니다." -ForegroundColor Yellow
    Write-Host "Ubuntu 설치 후 chezmoi apply를 다시 실행하세요." -ForegroundColor Yellow
    exit 0
}

try {
    wsl -d $ubuntu --cd ~ -- bash -lc "id -u" | Out-Null
} catch {
    Write-Host "Ubuntu 사용자 설정이 완료되지 않아 WSL secrets 설정을 건너뜁니다." -ForegroundColor Yellow
    Write-Host "Ubuntu를 1회 실행해 사용자 생성 후 chezmoi apply를 다시 실행하세요." -ForegroundColor Yellow
    exit 0
}

$wslBootstrap = @'
set -euo pipefail

mkdir -p "$HOME/.secrets"
chmod 700 "$HOME/.secrets" || true

if [ ! -f "$HOME/.secrets/dev.env.example" ]; then
  cat > "$HOME/.secrets/dev.env.example" <<"ENVEOF"
# format: KEY=VALUE
# 값은 따옴표 없이 넣어도 됩니다.

GITHUB_PAT=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GOOGLE_API_KEY=
ENVEOF
  chmod 600 "$HOME/.secrets/dev.env.example" || true
fi

START="# >>> DOTFILES SECRETS LOADER >>>"
END="# <<< DOTFILES SECRETS LOADER <<<"
TARGET="$HOME/.bashrc"
touch "$TARGET"

if [ ! -f "$HOME/.secrets/README.md" ]; then
  cat > "$HOME/.secrets/README.md" <<"READMEEOF"
# Local secrets directory

- 여기에 실제 토큰/API 키를 저장합니다.
- 이 디렉터리와 파일은 절대 git에 커밋하지 않습니다.
- 파일 포맷: KEY=VALUE

권장 파일:
- dev.env

점검:
- PowerShell: Secrets-Check
- WSL Bash: secrets_check
READMEEOF
  chmod 600 "$HOME/.secrets/README.md" || true
fi

if ! grep -Fq "$START" "$TARGET"; then
  cat >> "$TARGET" <<"BASHRCBLOCK"

# >>> DOTFILES SECRETS LOADER >>>
export SECRETS_DIR="$HOME/.secrets"

if [ -d "$SECRETS_DIR" ]; then
  for f in "$SECRETS_DIR"/*.env; do
    [ -f "$f" ] || continue
    set -a
    . "$f"
    set +a
  done
fi

secrets_check() {
  for k in GITHUB_PAT OPENAI_API_KEY ANTHROPIC_API_KEY GOOGLE_API_KEY; do
    if [ -n "${!k:-}" ]; then
      echo "$k: OK"
    else
      echo "$k: MISSING"
    fi
  done
}
# <<< DOTFILES SECRETS LOADER <<<
BASHRCBLOCK
fi
'@

$wslBootstrap | wsl -d $ubuntu --cd ~ -- bash -s --

Write-Host "WSL/Windows secrets 구조 설정 완료" -ForegroundColor Green
Write-Host "새 터미널에서 'secrets-check'로 확인하세요." -ForegroundColor Cyan
